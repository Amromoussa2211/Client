name: Android Emulator CI with WebDriverIO

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Set up Android environment variables
        run: |
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          mkdir -p $ANDROID_HOME

      - name: Set up Android Command Line Tools
        run: |
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O android-sdk.zip
          mkdir -p $ANDROID_HOME/cmdline-tools/latest
          unzip android-sdk.zip -d $ANDROID_HOME/cmdline-tools/latest
          rm android-sdk.zip

      - name: Verify sdkmanager is in PATH
        run: which sdkmanager

      - name: Update SDK Repositories
        run: |
          mkdir -p $ANDROID_HOME/repositories.cfg
          touch $ANDROID_HOME/repositories.cfg
          yes | sdkmanager --update

      - name: Install platform-tools
        run: |
          echo "Installing platform-tools..."
          sdkmanager --install "platform-tools" || { echo "Failed to install platform-tools"; exit 1; }

      - name: Install emulator
        run: |
          echo "Installing emulator..."
          sdkmanager --install "emulator" || { echo "Failed to install emulator"; exit 1; }

      - name: Install platforms
        run: |
          echo "Installing platforms;android-30..."
          sdkmanager --install "platforms;android-30" || { echo "Failed to install platforms"; exit 1; }

      - name: Install system-images
        run: |
          echo "Installing system-images;android-30;google_apis_playstore;x86..."
          sdkmanager --install "system-images;android-30;google_apis_playstore;x86" || { echo "Failed to install system-images"; exit 1; }
          echo "All SDK components installed successfully."

      - name: List Installed Packages
        run: sdkmanager --list

      - name: Verify SDK Setup
        run: |
          echo "Checking if platforms directory exists..."
          if [ -d "$ANDROID_HOME/platforms" ]; then
            echo "Platforms directory found."
          else
            echo "Platforms directory not found."
            exit 1
          fi
          echo "Checking if emulator directory exists..."
          if [ -d "$ANDROID_HOME/emulator" ]; then
            echo "Emulator directory found."
          else
            echo "Emulator directory not found."
            exit 1
          fi
          echo "Checking if system-images directory exists..."
          if [ -d "$ANDROID_HOME/system-images" ]; then
            echo "System-images directory found."
          else
            echo "System-images directory not found."
            exit 1
          fi
          echo "Checking if cmdline-tools directory exists..."
          if [ -d "$ANDROID_HOME/cmdline-tools/latest" ]; then
            echo "Cmdline-tools directory found."
          else
            echo "Cmdline-tools directory not found."
            exit 1
          fi

      - name: Verify emulator and adb are in PATH
        run: |
          which emulator
          which adb

      - name: Create and Start Emulator
        run: |
          echo no | avdmanager create avd --force -n test --abi "google_apis_playstore/x86" --package "system-images;android-30;google_apis_playstore;x86" --device "Nexus 6"
          emulator -avd test -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot -memory 2048 -cores 2 &
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          sleep 30 # Wait for the emulator to fully boot

      - name: Disable Animations
        run: |
          adb shell settings put global window_animation_scale 0.0
          adb shell settings put global transition_animation_scale 0.0
          adb shell settings put global animator_duration_scale 0.0

      - name: Download APK
        run: |
          mkdir -p ./apps
          curl -L -o ./apps/app-release-v15-0.3.2-2024-12-25-18-13.apk https://github.com/Amromoussa2211/client/releases/download/v1.0.0/app-release-v15-0.3.2-2024-12-25-18-13.apk

      - name: Install APK on Emulator
        run: adb install ./apps/app-release-v15-0.3.2-2024-12-25-18-13.apk

      - name: Start Appium Server
        run: |
          npm install -g appium@2
          appium --base-path /wd/hub &
          # Wait for Appium to start
          for i in {1..10}; do
            if curl -s localhost:4723/wd/hub/status | grep -q "status"; then
              echo "Appium server started"
              break
            fi
            sleep 5
          done

      - name: Run WebDriverIO Tests
        run: npx wdio run ./wdio.ci.conf.js

      - name: Force Stop Emulator
        run: |
          adb emu kill
          pkill -f "emulator" || true
